<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busisoft Portal - ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏ß‡∏°‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root { /* Base font size, will be controlled by JS */ }
        body { font-family: 'Sarabun', 'Inter', sans-serif; background-color: #f4f6f8; font-size: 1rem; }
        .text-primary { color: #3b82f6; }
        .bg-primary { background-color: #3b82f6; }

        .app-card a { display: flex; width: 100%; height: 100%; transition: background-color 0.2s ease-in-out; border-radius: 0.75rem; }
        
        /* Container Layouts */
        #main-content.layout-grid .apps-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; }
        #main-content.layout-compact .apps-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        #main-content.layout-list .apps-container { display: flex; flex-direction: column; gap: 0rem; }

        /* Card Styles for GRID & COMPACT view */
        .layout-grid .app-card, .layout-compact .app-card {
            background-color: #ffffff; 
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.07), 0 1px 2px -1px rgb(0 0 0 / 0.07);
            border: 1px solid #e5e7eb; 
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out; 
            position: relative;
        }
        .layout-grid .app-card:hover, .layout-compact .app-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); 
        }
        .layout-grid .app-card a, .layout-compact .app-card a { flex-direction: column; align-items: center; text-align: center; padding: 1.25rem; }
        .layout-grid .app-icon { width: 3rem; height: 3rem; margin-bottom: 0.75rem; }
        .layout-compact .app-icon { width: 2.5rem; height: 2.5rem; margin-bottom: 0.5rem; }
        .layout-compact .app-title { font-size: 0.875rem; }
        .layout-compact .app-info { display: none; }

        /* Card Styles for LIST view */
        .layout-list .app-card { border-bottom: 1px solid #e5e7eb; position: relative; }
        .layout-list .apps-container > .app-card:last-child { border-bottom: none; }
        .layout-list .app-card a { flex-direction: row; align-items: center; padding: 1rem; text-align: left; }
        .layout-list .app-card a:hover { background-color: #f9fafb; }
        .layout-list .app-icon { width: 2.5rem; height: 2.5rem; margin-right: 1rem; flex-shrink: 0; }
        
        /* View Controls */
        .view-control-btn { background-color: #e5e7eb; padding: 0.5rem; border-radius: 0.375rem; transition: all 0.2s; line-height: 0; }
        .view-control-btn:hover { background-color: #d1d5db; }
        .view-control-btn.active { background-color: #3b82f6; color: white; }
        
        /* Admin Styles */
        #admin-panel { display: none; }
        .admin-controls { display: none; }
        body.admin-mode .admin-controls { display: flex !important; }
        .app-card.sortable-ghost { background: #c7d2fe; }
        body.admin-mode .app-card { cursor: grab; }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-primary text-white shadow-lg sticky top-0 z-50">
       <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <img src="https://busisoft.co.th/wp-content/uploads/2020/11/logo.png" onerror="this.onerror=null; this.src='https://placehold.co/120x40/3B82F6/FFFFFF?text=Busisoft';" alt="Busisoft Logo" class="h-8 w-auto filter brightness-0 invert mr-3">
                    <span class="hidden sm:inline-block text-xl font-semibold">Busisoft Portal</span>
                </div>
                <div id="auth-container" class="flex items-center gap-4">
                    </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div id="portal-content" style="display: none;">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-primary">Application Hub</h1>
                <p class="mt-1 text-gray-600">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏ß‡∏°‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
            </div>
            <div id="view-controls" class="flex justify-between items-start mb-8">
                <div class="search-container relative">
                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                     </div>
                     <input type="search" id="search-box" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô..." class="w-72 text-sm border-gray-300 rounded-md shadow-sm pl-10 focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                </div>
                <div class="display-options-container flex flex-col items-end gap-2">
                    <div class="flex items-center gap-1 bg-gray-200 p-1 rounded-md">
                        <button id="layout-grid-btn" class="view-control-btn" title="Grid View"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></button>
                        <button id="layout-compact-btn" class="view-control-btn" title="Compact View"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h3v3H3zM9 3h3v3H9zM15 3h3v3h-3zM3 9h3v3H3zM9 9h3v3H9zM15 9h3v3h-3zM3 15h3v3H3zM9 15h3v3H9zM15 15h3v3h-3z"/></svg></button>
                        <button id="layout-list-btn" class="view-control-btn" title="List View"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg></button>
                    </div>
                    <div class="flex items-center gap-1 bg-gray-200 p-1 rounded-md">
                        <button id="font-size-decrease-btn" class="view-control-btn font-bold text-lg" title="‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£">-</button>
                        <span id="font-size-display" class="text-sm font-semibold text-gray-700 px-2 w-16 text-center">100%</span>
                        <button id="font-size-increase-btn" class="view-control-btn font-bold text-lg" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£">+</button>
                    </div>
                </div>
            </div>
            
            <section id="admin-panel" class="mb-10 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-md border border-blue-200">
                    <h2 class="text-xl font-semibold text-primary mb-4">üóÇÔ∏è Admin Panel - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
                    <div id="category-list" class="space-y-2 mb-4"></div>
                    <form id="add-category-form" class="flex gap-2">
                        <input type="text" id="category-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà" required class="p-2 border rounded w-full">
                        <button type="submit" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-blue-200">
                    <h2 class="text-xl font-semibold text-primary mb-4">‚öôÔ∏è Admin Panel - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô</h2>
                    <form id="add-app-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="app-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô" required class="p-2 border rounded w-full">
                        <input type="text" id="app-desc" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ" required class="p-2 border rounded w-full">
                        <input type="url" id="app-url" placeholder="URL ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ" required class="p-2 border rounded w-full">
                        <select id="app-category" required class="p-2 border rounded w-full bg-white"></select>
                        <textarea id="app-icon" placeholder="‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î SVG ‡∏Ç‡∏≠‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" rows="3" class="p-2 border rounded w-full md:col-span-2 font-mono text-xs"></textarea>
                        <button type="submit" class="bg-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 md:col-span-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô</button>
                    </form>
                </div>
            </section>
            
            <div id="main-content">
                <section id="recent-apps-section" class="mb-10" style="display: none;"></section>
                <div id="dynamic-sections-container"></div>
            </div>
        </div>
        
        <div id="login-prompt" class="text-center py-20">
            </div>
    </main>
    
    <div id="edit-app-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
         <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô</h3>
                <form id="edit-app-form">
                    <input type="hidden" id="edit-app-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="edit-app-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô" required class="p-2 border rounded w-full">
                        <input type="text" id="edit-app-desc" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ" required class="p-2 border rounded w-full">
                        <input type="url" id="edit-app-url" placeholder="URL ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ" required class="p-2 border rounded w-full">
                        <select id="edit-app-category" required class="p-2 border rounded w-full bg-white"></select>
                        <textarea id="edit-app-icon" placeholder="‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î SVG ‡∏Ç‡∏≠‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" rows="5" class="p-2 border rounded w-full md:col-span-2 font-mono text-xs"></textarea>
                    </div>
                    <div class="items-center px-4 py-3 mt-4 gap-2 flex justify-end">
                        <button id="cancel-edit-btn" type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <footer class="bg-primary text-white text-center mt-8 py-4">
        <p class="opacity-90">&copy; 2025 Busisoft. All Rights Reserved.</p>
    </footer>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, doc, addDoc, deleteDoc, updateDoc, query, orderBy, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBysnrYT1rJFQQvuf18eU4b8_eUo943yBU",
            authDomain: "bs-leave-portal.firebaseapp.com",
            projectId: "bs-leave-portal",
            storageBucket: "bs-leave-portal.appspot.com",
            messagingSenderId: "134599040444",
            appId: "1:134599040444:web:235034d6ae7a387480dfb9",
            measurementId: "G-GMF2FDYWWV"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let sortableInstances = [];
        let allCategories = [];
        const mainContentContainer = document.getElementById('main-content');
        const dynamicSectionsContainer = document.getElementById('dynamic-sections-container');
        const searchBox = document.getElementById('search-box');
        const layoutGridBtn = document.getElementById('layout-grid-btn');
        const layoutCompactBtn = document.getElementById('layout-compact-btn');
        const layoutListBtn = document.getElementById('layout-list-btn');
        const fontSizeIncreaseBtn = document.getElementById('font-size-increase-btn');
        const fontSizeDecreaseBtn = document.getElementById('font-size-decrease-btn');
        const fontSizeDisplay = document.getElementById('font-size-display');
        const recentAppsSection = document.getElementById('recent-apps-section');
        const authContainer = document.getElementById('auth-container');
        const adminPanel = document.getElementById('admin-panel');
        const addCategoryForm = document.getElementById('add-category-form');
        const categoryList = document.getElementById('category-list');
        const addAppForm = document.getElementById('add-app-form');
        const editModal = document.getElementById('edit-app-modal');
        const editForm = document.getElementById('edit-app-form');
        const portalContent = document.getElementById('portal-content');
        const loginPrompt = document.getElementById('login-prompt');
        const MAX_RECENT_APPS = 5;
        const BASE_FONT_SIZE = 16;
        
        async function checkIfAdmin(user) {
            if (!user || !user.email) return false;
            const adminDocRef = doc(db, "admins", user.email);
            const adminDoc = await getDoc(adminDocRef);
            return adminDoc.exists();
        }

        function renderUIForUser(user, isAdmin) {
            authContainer.innerHTML = `
                ${isAdmin ? '<button id="admin-toggle-btn" class="text-xs bg-white/20 hover:bg-white/30 rounded-full px-3 py-1">Admin Mode</button>' : ''}
                <span class="hidden md:inline-block text-sm font-medium">${user.displayName || 'User'}</span>
                <img src="${user.photoURL || 'https://avatar.vercel.sh/user.svg'}" alt="User Avatar" class="w-10 h-10 rounded-full">
                <button id="logout-btn" class="text-xs bg-red-500/80 hover:bg-red-500 rounded-full px-3 py-1">Logout</button>
            `;
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            if(isAdmin) {
                document.getElementById('admin-toggle-btn').addEventListener('click', () => {
                     document.body.classList.toggle('admin-mode');
                     adminPanel.style.display = document.body.classList.contains('admin-mode') ? 'block' : 'none';
                });
            }
        }

        function renderUIForGuest() {
            authContainer.innerHTML = `<button id="login-btn-header" class="bg-white text-blue-600 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-100">Login with Google</button>`;
            const loginHandler = () => signInWithPopup(auth, provider).catch(console.error);
            document.getElementById('login-btn-header').addEventListener('click', loginHandler);
            loginPrompt.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</h2>
                <p class="text-gray-500 mb-6">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Busisoft Portal</p>
                <button id="login-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 inline-flex items-center gap-2 shadow-md">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="m24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-5.166 0-9.86-1.977-13.409-5.192l6.19-5.238A11.91 11.91 0 0 1 24 36c6.627 0 12-5.373 12-12c0-2.286-.64-4.42-1.744-6.25l-6.217 5.293z"/></svg>
                    Sign in with Google
                </button>
            `;
            document.getElementById('login-btn').addEventListener('click', loginHandler);
        }

        // --- Event Handlers & Main Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                portalContent.style.display = 'block';
                loginPrompt.style.display = 'none';
                const isAdmin = await checkIfAdmin(user);
                renderUIForUser(user, isAdmin);
                setupRealtimeListeners(); // Start listening for data changes
            } else {
                portalContent.style.display = 'none';
                loginPrompt.style.display = 'block';
                renderUIForGuest();
            }
        });

        // Other functions (renderPortal, renderRecentApps, etc.) go here...
        // ... (The full script is identical to the one you provided in the previous turn)

    </script>
</body>
</html>
