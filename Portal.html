<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busisoft Portal - ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏ß‡∏°‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root { /* Base font size, will be controlled by JS */ }
        body { font-family: 'Sarabun', 'Inter', sans-serif; background-color: #f4f6f8; font-size: 1rem; }
        .text-primary { color: #3b82f6; }
        .bg-primary { background-color: #3b82f6; }
        .app-card a { display: flex; width: 100%; height: 100%; transition: background-color 0.2s ease-in-out; border-radius: 0.75rem; }
        
        /* Layouts */
        .layout-grid .apps-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; }
        .layout-compact .apps-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .layout-list .apps-container { display: flex; flex-direction: column; gap: 0rem; }
        .layout-list .app-card { border-bottom: 1px solid #e5e7eb; border-radius: 0; }
        .layout-list .apps-container > .app-card:last-child { border-bottom: none; }
        .layout-list .app-card:hover { background-color: #f9fafb; }
        
        /* View Controls */
        .view-control-btn { background-color: #e5e7eb; padding: 0.5rem; border-radius: 0.375rem; transition: all 0.2s; line-height: 0; }
        .view-control-btn:hover { background-color: #d1d5db; }
        .view-control-btn.active { background-color: #3b82f6; color: white; }

        /* Admin Styles */
        #admin-panel { display: none; }
        body.admin-mode #admin-panel { display: block; }
        .admin-controls { display: none; }
        body.admin-mode .admin-controls { display: flex !important; }
        .app-card.sortable-ghost, .category-section.sortable-ghost { background-color: #c7d2fe80; border-radius: 1rem; }
        .drag-handle { display: none; cursor: grab; color: #9ca3af; padding: 0.5rem; }
        body.admin-mode .drag-handle { display: flex; align-items: center; }

        /* Modal Styles */
        #admin-modal-overlay { transition: opacity 0.3s ease; }
        #admin-modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-input {
             width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 0.375rem; transition: all 0.2s;
        }
        .modal-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px #bfdbfe; outline: none; }
        
        /* Gemini Chat Styles */
        .chat-bubble-user { background-color: #dbeafe; color: #1e40af; }
        .chat-bubble-ai { background-color: #f3f4f6; color: #1f2937; }
        .tts-button { cursor: pointer; }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-primary text-white shadow-lg sticky top-0 z-50">
       <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <img src="https://busisoft.co.th/wp-content/uploads/2020/11/logo.png" onerror="this.onerror=null; this.src='https://placehold.co/120x40/3B82F6/FFFFFF?text=Busisoft';" alt="Busisoft Logo" class="h-8 w-auto filter brightness-0 invert mr-3">
                    <span class="hidden sm:inline-block text-xl font-semibold">Busisoft Portal</span>
                </div>
                <div class="flex items-center">
                    <button id="admin-toggle-btn" class="text-xs bg-white/20 hover:bg-white/30 rounded-full px-3 py-1 mr-4 transition-all">Admin Mode</button>
                    <span class="hidden md:inline-block mr-3 text-sm font-medium">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, User</span>
                    <div class="w-10 h-10 bg-white/30 rounded-full flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-primary">Application Hub</h1>
            <p class="mt-1 text-gray-600">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏ß‡∏°‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p>
        </div>
        
        <div id="view-controls" class="flex justify-between items-start mb-8">
            <div class="search-container relative">
                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                 </div>
                 <input type="search" id="search-box" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô..." class="w-72 text-sm border-gray-300 rounded-md shadow-sm pl-10 focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            </div>
            <div class="display-options-container flex flex-col items-end gap-2">
                <div class="flex items-center gap-1 bg-gray-200 p-1 rounded-md">
                    <button id="layout-grid-btn" class="view-control-btn w-9 h-9 flex items-center justify-center" title="Grid View"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></button>
                    <button id="layout-compact-btn" class="view-control-btn w-9 h-9 flex items-center justify-center" title="Compact View"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h3v3H3zM9 3h3v3H9zM15 3h3v3h-3zM3 9h3v3H3zM9 9h3v3H9zM15 9h3v3h-3zM3 15h3v3H3zM9 15h3v3H9zM15 15h3v3h-3z"/></svg></button>
                    <button id="layout-list-btn" class="view-control-btn w-9 h-9 flex items-center justify-center" title="List View"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg></button>
                </div>
                <div class="flex items-center bg-gray-200 p-1 rounded-md">
                    <button id="font-size-decrease-btn" class="view-control-btn w-8 h-8 flex items-center justify-center" title="‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    <span id="font-size-display" class="text-xs font-medium text-gray-700 w-12 h-8 flex items-center justify-center">100%</span>
                    <button id="font-size-increase-btn" class="view-control-btn w-8 h-8 flex items-center justify-center" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
            </div>
        </div>

        <section id="admin-panel" class="mb-10 p-6 bg-white rounded-lg shadow-md border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Control Panel</h2>
            <div class="flex items-center gap-4">
                <button id="add-category-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</button>
                <button id="add-app-btn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏õ‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </section>
        
        <section id="recent-apps-section" class="mb-10" style="display: none;"></section>
        <div id="dynamic-sections-container"></div>
    </main>
    
    <footer class="bg-primary text-white text-center mt-8 py-6">
        <p class="opacity-90">&copy; 2025 Busisoft. All Rights Reserved.</p>
        <div class="flex justify-center gap-6 mt-4">
            <a href="https://busisoft.co.th/" target="_blank" rel="noopener noreferrer" title="Busisoft Website" class="hover:opacity-75 transition-opacity"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></a>
            <a href="https://www.facebook.com/busisoftthai" target="_blank" rel="noopener noreferrer" title="Facebook" class="hover:opacity-75 transition-opacity"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></a>
            <a href="https://www.youtube.com/@busisoftthailand7568" target="_blank" rel="noopener noreferrer" title="YouTube" class="hover:opacity-75 transition-opacity"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2A29 29 0 0 0 23 11.75a29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg></a>
            <a href="https://www.instagram.com/busisoft_official/" target="_blank" rel="noopener noreferrer" title="Instagram" class="hover:opacity-75 transition-opacity"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></a>
        </div>
    </footer>

    <!-- Admin Modal -->
    <div id="admin-modal-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4 opacity-0">
        <div id="admin-modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95 opacity-0">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="admin-modal-title" class="text-2xl font-bold text-gray-800"></h3>
                <button id="admin-modal-close-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <form id="admin-modal-form" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Form fields will be injected here by JavaScript -->
            </form>
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                <button id="admin-modal-cancel-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="admin-modal-save-btn" class="bg-primary text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
    
    <!-- START: Gemini UI Elements (Restored) -->
    <button id="gemini-fab" class="fixed bottom-8 right-8 bg-primary text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg hover:bg-blue-700 transition-colors z-40">
        <span class="text-3xl">ü§ñ</span>
    </button>

    <div id="gemini-chat-window" class="hidden fixed bottom-28 right-8 w-full max-w-md bg-white rounded-xl shadow-2xl z-40 transform transition-all duration-300">
        <div class="flex items-center justify-between p-4 bg-gray-100 border-b border-gray-200 rounded-t-xl">
            <h3 class="font-semibold text-lg text-gray-800">Gemini Assistant</h3>
            <button id="close-gemini-chat" class="text-gray-500 hover:text-gray-800">&times;</button>
        </div>
        <div id="chat-history" class="p-4 h-96 overflow-y-auto space-y-4"></div>
        <div id="typing-indicator" class="hidden p-4 text-sm text-gray-500">Gemini is typing...</div>
        <div id="file-preview-container" class="hidden items-center justify-between p-2 mx-4 bg-gray-100 rounded-md">
            <span id="file-name" class="text-sm text-gray-700 truncate"></span>
            <button id="remove-file-btn" class="text-red-500 hover:text-red-700">&times;</button>
        </div>
        <form id="chat-form" class="p-4 border-t border-gray-200">
            <div class="flex items-center gap-2">
                <label for="file-input" class="cursor-pointer text-gray-500 hover:text-primary p-2">üìé</label>
                <input type="file" id="file-input" class="hidden">
                <button type="button" id="open-scanner-btn" class="text-gray-500 hover:text-primary p-2">üì∑</button>
                <textarea id="chat-input" placeholder="Type your message..." class="flex-grow p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 resize-none" rows="1"></textarea>
                <button id="send-btn" type="submit" class="bg-primary text-white p-2 rounded-lg hover:bg-blue-700">Send</button>
            </div>
        </form>
    </div>
    
    <div id="scanner-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-4 rounded-lg">
            <video id="scanner-video" class="w-full h-auto rounded"></video>
            <canvas id="scanner-canvas" class="hidden"></canvas>
            <input id="scanner-prompt" placeholder="Optional: Add a prompt for the image..." class="w-full mt-2 p-2 border rounded">
            <div class="flex justify-end gap-2 mt-2">
                <button id="cancel-scan-btn" class="bg-gray-200 px-4 py-2 rounded">Cancel</button>
                <button id="capture-btn" class="bg-primary text-white px-4 py-2 rounded">Capture & Send</button>
            </div>
        </div>
    </div>
    <!-- END: Gemini UI Elements -->
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, doc, addDoc, deleteDoc, updateDoc, query, orderBy, writeBatch, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBysnrYT1rJFQQvuf18eU4b8_eUo943yBU",
            authDomain: "bs-leave-portal.firebaseapp.com",
            projectId: "bs-leave-portal",
            storageBucket: "bs-leave-portal.appspot.com",
            messagingSenderId: "134599040444",
            appId: "1:134599040444:web:235034d6ae7a387480dfb9",
            measurementId: "G-GMF2FDYWWV"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- DOM Elements ---
        const dynamicSectionsContainer = document.getElementById('dynamic-sections-container');
        const searchBox = document.getElementById('search-box');
        const layoutGridBtn = document.getElementById('layout-grid-btn');
        const layoutCompactBtn = document.getElementById('layout-compact-btn');
        const layoutListBtn = document.getElementById('layout-list-btn');
        const fontSizeIncreaseBtn = document.getElementById('font-size-increase-btn');
        const fontSizeDecreaseBtn = document.getElementById('font-size-decrease-btn');
        const fontSizeDisplay = document.getElementById('font-size-display');
        const recentAppsSection = document.getElementById('recent-apps-section');
        const adminToggleBtn = document.getElementById('admin-toggle-btn');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const addAppBtn = document.getElementById('add-app-btn');
        const modalOverlay = document.getElementById('admin-modal-overlay');
        const modalContent = document.getElementById('admin-modal-content');
        const modalTitle = document.getElementById('admin-modal-title');
        const modalForm = document.getElementById('admin-modal-form');
        const modalSaveBtn = document.getElementById('admin-modal-save-btn');
        const modalCancelBtn = document.getElementById('admin-modal-cancel-btn');
        const modalCloseBtn = document.getElementById('admin-modal-close-btn');

        // --- Global State ---
        let allCategories = [];
        let sortableInstances = [];
        const BASE_FONT_SIZE = 16;
        
        // --- MODAL UI LOGIC ---
        function openModal() {
            modalOverlay.classList.remove('hidden');
            setTimeout(() => {
                modalOverlay.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeModal() {
            modalOverlay.classList.add('opacity-0');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modalOverlay.classList.add('hidden');
                modalForm.innerHTML = '';
                modalSaveBtn.onclick = null;
            }, 300);
        }

        [modalCancelBtn, modalCloseBtn].forEach(btn => btn.onclick = closeModal);
        modalOverlay.onclick = (e) => { if (e.target === modalOverlay) closeModal(); };

        function showCategoryModal(category = null) {
            const isEditing = category !== null;
            modalTitle.textContent = isEditing ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà';
            
            modalForm.innerHTML = `
                <div><label for="category-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><input type="text" id="category-name" class="modal-input mt-1" value="${isEditing ? category.name : ''}" required></div>
                <div><label for="category-emoji" class="block text-sm font-medium text-gray-700">Emoji</label><input type="text" id="category-emoji" class="modal-input mt-1" value="${isEditing ? category.emoji : ''}"></div>
            `;
            
            modalSaveBtn.onclick = async () => {
                const name = document.getElementById('category-name').value;
                if (!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà');
                const emoji = document.getElementById('category-emoji').value;
                try {
                    isEditing ? await updateDoc(doc(db, 'categories', category.id), { name, emoji }) : await addDoc(collection(db, 'categories'), { name, emoji, order: allCategories.length });
                    closeModal();
                } catch (e) { console.error("Error saving category:", e); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
            };
            openModal();
        }
        
        function showAppModal(app = null, currentCategoryId = null) {
            const isEditing = app !== null;
            modalTitle.textContent = isEditing ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏≠‡∏õ‡πÉ‡∏´‡∏°‡πà';

            const categoryOptions = allCategories.sort((a, b) => a.order - b.order).map(cat => `<option value="${cat.id}" ${cat.id === currentCategoryId ? 'selected' : ''}>${cat.name}</option>`).join('');
            
            modalForm.innerHTML = `
                <div><label for="app-category" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select id="app-category" class="modal-input mt-1">${categoryOptions}</select></div>
                <div><label for="app-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ</label><input type="text" id="app-name" class="modal-input mt-1" value="${isEditing ? app.name : ''}" required></div>
                <div><label for="app-desc" class="block text-sm font-medium text-gray-700">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label><input type="text" id="app-desc" class="modal-input mt-1" value="${isEditing ? app.description : ''}"></div>
                <div><label for="app-url" class="block text-sm font-medium text-gray-700">URL</label><input type="url" id="app-url" class="modal-input mt-1" value="${isEditing ? app.url : ''}" required></div>
                <div><label for="app-icon" class="block text-sm font-medium text-gray-700">SVG Icon Code</label><textarea id="app-icon" rows="3" class="modal-input mt-1">${isEditing ? app.icon : ''}</textarea></div>
            `;

            modalSaveBtn.onclick = async () => {
                const newCategoryId = document.getElementById('app-category').value;
                const name = document.getElementById('app-name').value;
                if (!newCategoryId || !name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
                
                const appData = { name, description: document.getElementById('app-desc').value, url: document.getElementById('app-url').value, icon: document.getElementById('app-icon').value };

                try {
                    if (isEditing) {
                        if (newCategoryId === currentCategoryId) {
                            await updateDoc(doc(db, `categories/${currentCategoryId}/apps/${app.id}`), appData);
                        } else {
                            const appRefFrom = doc(db, `categories/${currentCategoryId}/apps/${app.id}`);
                            const appRefTo = doc(db, `categories/${newCategoryId}/apps/${app.id}`);
                            const appSnapshot = await getDoc(appRefFrom);
                            if (appSnapshot.exists()) {
                                const newOrder = allCategories.find(c => c.id === newCategoryId).apps.length;
                                const batch = writeBatch(db);
                                batch.set(appRefTo, { ...appSnapshot.data(), ...appData, order: newOrder });
                                batch.delete(appRefFrom);
                                await batch.commit();
                            }
                        }
                    } else {
                        const order = allCategories.find(c => c.id === newCategoryId).apps.length;
                        await addDoc(collection(db, `categories/${newCategoryId}/apps`), { ...appData, order });
                    }
                    closeModal();
                } catch (e) { console.error("Error saving app:", e); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
            };
            openModal();
        }

        // --- ADMIN MODE LOGIC ---
        addCategoryBtn.onclick = () => showCategoryModal();
        addAppBtn.onclick = () => showAppModal(null, allCategories.length > 0 ? allCategories[0].id : null);

        adminToggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('admin-mode');
            adminToggleBtn.textContent = document.body.classList.contains('admin-mode') ? 'Exit Admin' : 'Admin Mode';
            adminToggleBtn.classList.toggle('bg-red-500');
            adminToggleBtn.classList.toggle('text-white');
            renderPortal();
        });

        function attachAdminEventListeners() {
            document.querySelectorAll('.edit-category-btn').forEach(btn => btn.onclick = (e) => { e.stopPropagation(); const cat = allCategories.find(c => c.id === btn.dataset.categoryId); if (cat) showCategoryModal(cat); });
            document.querySelectorAll('.edit-app-btn').forEach(btn => btn.onclick = (e) => { e.stopPropagation(); const { appId, categoryId } = btn.dataset; const app = allCategories.find(c => c.id === categoryId)?.apps.find(a => a.id === appId); if (app) showAppModal(app, categoryId); });
            document.querySelectorAll('.delete-app-btn').forEach(btn => btn.onclick = async (e) => { e.stopPropagation(); if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏≠‡∏õ?')) await deleteDoc(doc(db, `categories/${btn.dataset.categoryId}/apps/${btn.dataset.appId}`)); });
            document.querySelectorAll('.delete-category-btn').forEach(btn => btn.onclick = async (e) => { e.stopPropagation(); const cat = allCategories.find(c => c.id === btn.dataset.categoryId); if (cat.apps.length > 0) return alert('‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡πÅ‡∏≠‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô'); if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${cat.name}"?`)) await deleteDoc(doc(db, `categories/${btn.dataset.categoryId}`)); });
        }
        
        // --- Drag & Drop ---
        function initializeAllSortables() {
            destroyAllSortables();
            const containerSortable = new Sortable(dynamicSectionsContainer, { animation: 150, handle: '.drag-handle.category-handle', onEnd: async (evt) => { const batch = writeBatch(db); dynamicSectionsContainer.querySelectorAll('.category-section').forEach((section, index) => { batch.update(doc(db, 'categories', section.dataset.categoryId), { order: index }); }); await batch.commit(); }, });
            sortableInstances.push(containerSortable);
            document.querySelectorAll('.apps-container').forEach(container => { const appSortable = new Sortable(container, { group: 'apps', animation: 150, handle: '.drag-handle.app-handle', onEnd: handleAppSortEnd, }); sortableInstances.push(appSortable); });
        }
        async function handleAppSortEnd(evt) {
            const { item, from, to } = evt; const appId = item.dataset.appId; const fromCategoryId = from.closest('.category-section').dataset.categoryId; const toCategoryId = to.closest('.category-section').dataset.categoryId; const batch = writeBatch(db);
            if (fromCategoryId !== toCategoryId) { const appRefFrom = doc(db, `categories/${fromCategoryId}/apps/${appId}`); const appRefTo = doc(db, `categories/${toCategoryId}/apps/${appId}`); try { const appSnapshot = await getDoc(appRefFrom); if (appSnapshot.exists()) { batch.set(appRefTo, appSnapshot.data()); batch.delete(appRefFrom); } } catch (e) { console.error("Error moving doc:", e); return; } }
            to.querySelectorAll('.app-card').forEach((card, index) => { batch.update(doc(db, `categories/${toCategoryId}/apps/${card.dataset.appId}`), { order: index }); });
            if (fromCategoryId !== toCategoryId) { from.querySelectorAll('.app-card').forEach((card, index) => { batch.update(doc(db, `categories/${fromCategoryId}/apps/${card.dataset.appId}`), { order: index }); }); }
            try { await batch.commit(); } catch (e) { console.error("Error committing batch sort:", e); }
        }
        function destroyAllSortables() { sortableInstances.forEach(i => i.destroy()); sortableInstances = []; }

        // --- Render Functions ---
        function createAppCard(app, categoryId) {
            const appCard = document.createElement('div');
            appCard.className = 'app-card flex items-center bg-white shadow-sm rounded-lg';
            appCard.dataset.appId = app.id;
            
            const iconSvg = app.icon || `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M21.25 16.25V7.75a2 2 0 00-2-2H4.75a2 2 0 00-2 2v8.5a2 2 0 002 2h14.5a2 2 0 002-2zM2.75 8.75h18.5"/><path d="M7 11.75h3m-3 3h6"/></svg>`;
            const dragHandle = `<div class="drag-handle app-handle"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle><circle cx="5" cy="5" r="1"></circle><circle cx="5" cy="12" r="1"></circle><circle cx="5" cy="19" r="1"></circle></svg></div>`;

            appCard.innerHTML = `
                ${dragHandle}
                <a href="${app.url}" target="_blank" rel="noopener noreferrer" class="flex-grow flex items-center p-4">
                    <div class="app-icon mr-4 flex-shrink-0 w-10 h-10 flex items-center justify-center">${iconSvg}</div>
                    <div class="text-left"><h3 class="app-title font-semibold text-gray-800">${app.name}</h3><p class="app-info text-sm text-gray-500">${app.description}</p></div>
                </a>
                <div class="admin-controls absolute top-2 right-2 gap-1 z-10">
                    <button data-app-id="${app.id}" data-category-id="${categoryId}" class="edit-app-btn bg-yellow-400 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm hover:bg-yellow-500">‚úèÔ∏è</button>
                    <button data-app-id="${app.id}" data-category-id="${categoryId}" class="delete-app-btn bg-red-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm hover:bg-red-600">X</button>
                </div>`;
            appCard.querySelector('a').onclick = (e) => { if (document.body.classList.contains('admin-mode')) e.preventDefault(); };
            return appCard;
        }
        
        function renderPortal() {
            const isAdminMode = document.body.classList.contains('admin-mode');
            dynamicSectionsContainer.innerHTML = '';
            
            allCategories.sort((a, b) => a.order - b.order).forEach(category => {
                const section = document.createElement('section');
                section.className = 'category-section mb-10';
                section.dataset.categoryId = category.id;
                
                if (category.apps.length === 0 && !isAdminMode) return;
                
                const dragHandle = `<div class="drag-handle category-handle"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle><circle cx="5" cy="5" r="1"></circle><circle cx="5" cy="12" r="1"></circle><circle cx="5" cy="19" r="1"></circle></svg></div>`;
                const adminCategoryControls = isAdminMode ? `
                    <button data-category-id="${category.id}" class="edit-category-btn text-gray-500 hover:text-blue-500 ml-4 text-xs p-1 rounded-full">‚úèÔ∏è</button>
                    <button data-category-id="${category.id}" class="delete-category-btn text-gray-500 hover:text-red-500 ml-1 text-xs p-1 rounded-full">üóëÔ∏è</button>` : '';
                
                section.innerHTML = `
                    <div class="flex items-center mb-4 border-b border-blue-200 pb-2">
                        ${dragHandle}
                        <h2 class="category-title text-xl font-semibold text-primary">${category.emoji || 'üìÅ'} ${category.name}</h2>
                        ${adminCategoryControls}
                    </div><div class="apps-container"></div>`;
                
                const gridContainer = section.querySelector('.apps-container');
                (category.apps || []).sort((a,b) => a.order - b.order).forEach(app => gridContainer.appendChild(createAppCard(app, category.id)));
                dynamicSectionsContainer.appendChild(section);
            });
            
            isAdminMode ? (attachAdminEventListeners(), initializeAllSortables()) : destroyAllSortables();
        }

        // --- UI Functions ---
        function applyLayout(layoutName) {
            document.body.classList.remove('layout-grid', 'layout-compact', 'layout-list');
            document.body.classList.add(`layout-${layoutName}`);
            [layoutGridBtn, layoutCompactBtn, layoutListBtn].forEach(btn => btn.classList.remove('active'));
            document.getElementById(`layout-${layoutName}-btn`).classList.add('active');
            localStorage.setItem('portalLayout', layoutName);
        }
        
        function updateFontSizeDisplay() {
            const currentSize = parseFloat(localStorage.getItem('portalFontSize')) || BASE_FONT_SIZE;
            const percentage = Math.round((currentSize / BASE_FONT_SIZE) * 100);
            fontSizeDisplay.textContent = `${percentage}%`;
            document.documentElement.style.fontSize = `${currentSize}px`;
        }

        function changeFontSize(delta) {
            let currentSize = parseFloat(localStorage.getItem('portalFontSize')) || BASE_FONT_SIZE;
            let newSize = currentSize + delta;
            if (newSize < 12) newSize = 12;
            if (newSize > 20) newSize = 20;
            localStorage.setItem('portalFontSize', newSize);
            updateFontSizeDisplay();
        }

        function handleSearch() {
            const searchTerm = searchBox.value.toLowerCase().trim();
            document.querySelectorAll('.category-section').forEach(section => {
                let hasVisibleApp = false;
                section.querySelectorAll('.app-card').forEach(card => {
                    const isVisible = card.textContent.toLowerCase().includes(searchTerm);
                    card.style.display = isVisible ? 'flex' : 'none'; // Use flex for list view
                    if(isVisible) hasVisibleApp = true;
                });
                section.style.display = hasVisibleApp ? 'block' : 'none';
            });
        }
        
        // --- Data Fetching & Initial Load ---
        async function fetchAndRenderData() {
            onSnapshot(query(collection(db, "categories"), orderBy("order")), async (categoriesSnapshot) => {
                const categoriesData = categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), apps: [] }));
                const appPromises = categoriesData.map(async (category) => {
                    const appsSnapshot = await getDocs(query(collection(db, `categories/${category.id}/apps`), orderBy("order")));
                    category.apps = appsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    return category;
                });
                allCategories = await Promise.all(appPromises);
                renderPortal();
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, user => { if (!user) signInAnonymously(auth).catch(console.error); });
            fetchAndRenderData();
            
            applyLayout(localStorage.getItem('portalLayout') || 'grid');
            updateFontSizeDisplay();
            layoutGridBtn.addEventListener('click', () => applyLayout('grid'));
            layoutCompactBtn.addEventListener('click', () => applyLayout('compact'));
            layoutListBtn.addEventListener('click', () => applyLayout('list'));
            fontSizeIncreaseBtn.addEventListener('click', () => changeFontSize(1));
            fontSizeDecreaseBtn.addEventListener('click', () => changeFontSize(-1));
            searchBox.addEventListener('input', handleSearch);
        });
    </script>

    <!-- This script MUST be separate and after the module -->
    <script src="gemini-logic.js"></script>
</body>
</html>


